# CD Pipeline - Branch 06: Complete Pipeline
# This is the final, production-ready CD pipeline with all features.
#
# Features included:
# - Comprehensive testing
# - Docker build with caching
# - Container registry push
# - Security scanning
# - Staging deployment with smoke tests
# - Production deployment with manual approval
# - Automatic rollback capabilities
# - Deployment notifications
# - Version tracking
# - Concurrency control

name: CD Pipeline

on:
  push:
    branches: [main, "06-complete"]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      rollback_version:
        description: "Version to rollback to (commit SHA)"
        required: false
        type: string
      environment:
        description: "Environment to rollback"
        required: true
        type: choice
        options:
          - staging
          - production
        default: staging
      skip_tests:
        description: "Skip tests (use with caution)"
        required: false
        type: boolean
        default: false

# Prevent concurrent deployments to the same environment
concurrency:
  group: cd-${{ github.ref }}
  cancel-in-progress: false

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  PYTHON_VERSION: "3.11"

jobs:
  # ============================================
  # PHASE 1: PREPARATION
  # ============================================

  prepare:
    name: Prepare Pipeline
    runs-on: ubuntu-latest
    outputs:
      is-rollback: ${{ steps.check.outputs.is_rollback }}
      rollback-version: ${{ steps.check.outputs.rollback_version }}
      target-env: ${{ steps.check.outputs.target_env }}
      short-sha: ${{ steps.vars.outputs.short_sha }}
      deploy-staging: ${{ steps.check.outputs.deploy_staging }}
      deploy-production: ${{ steps.check.outputs.deploy_production }}

    steps:
      - name: Check pipeline type
        id: check
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ] && [ -n "${{ inputs.rollback_version }}" ]; then
            echo "is_rollback=true" >> $GITHUB_OUTPUT
            echo "rollback_version=${{ inputs.rollback_version }}" >> $GITHUB_OUTPUT
            echo "target_env=${{ inputs.environment }}" >> $GITHUB_OUTPUT
            echo "deploy_staging=false" >> $GITHUB_OUTPUT
            echo "deploy_production=false" >> $GITHUB_OUTPUT
          else
            echo "is_rollback=false" >> $GITHUB_OUTPUT
            echo "deploy_staging=${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}" >> $GITHUB_OUTPUT
            echo "deploy_production=${{ github.ref == 'refs/heads/main' && github.event_name == 'push' }}" >> $GITHUB_OUTPUT
          fi

      - name: Set variables
        id: vars
        run: |
          echo "short_sha=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

  # ============================================
  # PHASE 2: BUILD & TEST (Parallel)
  # ============================================

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.is-rollback != 'true' && inputs.skip_tests != true

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt

      - name: Run linting
        run: |
          flake8 src tests --count --select=E9,F63,F7,F82 --show-source --statistics

      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=html --junitxml=test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: |
            test-results.xml
            htmlcov/
            coverage.xml

  security-scan-code:
    name: Security Scan (Code)
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.is-rollback != 'true'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit safety

      - name: Run Bandit security scan
        run: |
          bandit -r src -f json -o bandit-results.json || true
          bandit -r src -f txt

      - name: Check dependencies for vulnerabilities
        run: |
          pip install -r requirements.txt
          safety check --json > safety-results.json || true
          safety check

      - name: Upload security results
        uses: actions/upload-artifact@v4
        with:
          name: security-scan-code
          path: |
            bandit-results.json
            safety-results.json

  # ============================================
  # PHASE 3: BUILD & PUSH
  # ============================================

  build-and-push:
    name: Build & Push Image
    runs-on: ubuntu-latest
    needs: [prepare, test, security-scan-code]
    if: |
      always() &&
      needs.prepare.outputs.is-rollback != 'true' &&
      github.event_name == 'push' &&
      (needs.test.result == 'success' || needs.test.result == 'skipped') &&
      (needs.security-scan-code.result == 'success' || needs.security-scan-code.result == 'skipped')

    permissions:
      contents: read
      packages: write

    outputs:
      image-tag: ${{ github.sha }}
      image-digest: ${{ steps.build.outputs.digest }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix=
            type=ref,event=branch
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' }}
            type=raw,value=${{ needs.prepare.outputs.short-sha }}

      - name: Build and push Docker image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64

      - name: Output image info
        run: |
          echo "### Docker Image Built" >> $GITHUB_STEP_SUMMARY
          echo "- **Digest:** ${{ steps.build.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Tags:** ${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY

  security-scan-image:
    name: Security Scan (Image)
    runs-on: ubuntu-latest
    needs: build-and-push
    if: needs.build-and-push.result == 'success'

    permissions:
      contents: read
      packages: read
      security-events: write

    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}
          format: "sarif"
          output: "trivy-results.sarif"
          severity: "CRITICAL,HIGH"

      - name: Upload Trivy scan results
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: "trivy-results.sarif"

  # ============================================
  # PHASE 4: STAGING DEPLOYMENT
  # ============================================

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [prepare, build-and-push, security-scan-image]
    if: |
      needs.prepare.outputs.deploy-staging == 'true' &&
      needs.build-and-push.result == 'success'

    environment:
      name: staging
      url: http://staging.example.com

    outputs:
      previous-version: ${{ steps.record.outputs.previous_version }}
      deployed-version: ${{ github.sha }}

    steps:
      - name: Record previous version
        id: record
        run: |
          # In production, fetch from deployment state
          echo "previous_version=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Deploy to Staging
        run: |
          echo "Deploying ${{ github.sha }} to staging..."
          echo "Image: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}"

      - name: Wait for deployment
        run: sleep 10

      - name: Update deployment record
        run: |
          echo "### Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed" >> $GITHUB_STEP_SUMMARY

  smoke-tests-staging:
    name: Smoke Tests (Staging)
    runs-on: ubuntu-latest
    needs: deploy-staging

    outputs:
      passed: ${{ steps.tests.outputs.passed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run smoke tests
        id: tests
        run: |
          echo "Running smoke tests against staging..."
          # Add actual smoke test commands here
          echo "passed=true" >> $GITHUB_OUTPUT

  auto-rollback-staging:
    name: Auto-Rollback (Staging)
    runs-on: ubuntu-latest
    needs: [deploy-staging, smoke-tests-staging]
    if: failure()

    environment:
      name: staging

    steps:
      - name: Rollback staging
        run: |
          echo "Rolling back staging to ${{ needs.deploy-staging.outputs.previous-version }}"

  # ============================================
  # PHASE 5: PRODUCTION DEPLOYMENT
  # ============================================

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [prepare, smoke-tests-staging]
    if: |
      needs.prepare.outputs.deploy-production == 'true' &&
      needs.smoke-tests-staging.result == 'success'

    environment:
      name: production
      url: http://production.example.com

    outputs:
      previous-version: ${{ steps.record.outputs.previous_version }}
      deployed-version: ${{ github.sha }}

    steps:
      - name: Record previous version
        id: record
        run: |
          echo "previous_version=$(date +%s)" >> $GITHUB_OUTPUT

      - name: Blue-Green Deploy
        run: |
          echo "=== Blue-Green Deployment ==="
          echo "Step 1: Deploy to green environment..."
          echo "Step 2: Health check green..."
          echo "Step 3: Switch traffic to green..."
          echo "Step 4: Monitor for issues..."
          echo "Production deployment complete!"

      - name: Update deployment record
        run: |
          echo "### Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy:** Blue-Green" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** Deployed" >> $GITHUB_STEP_SUMMARY

  health-check-production:
    name: Health Check (Production)
    runs-on: ubuntu-latest
    needs: deploy-production

    outputs:
      passed: ${{ steps.health.outputs.passed }}

    steps:
      - name: Wait for stabilization
        run: sleep 15

      - name: Run health checks
        id: health
        run: |
          echo "Running production health checks..."
          echo "passed=true" >> $GITHUB_OUTPUT

  auto-rollback-production:
    name: Auto-Rollback (Production)
    runs-on: ubuntu-latest
    needs: [deploy-production, health-check-production]
    if: failure()

    environment:
      name: production

    steps:
      - name: Emergency rollback
        run: |
          echo "=== EMERGENCY ROLLBACK ==="
          echo "Rolling back to ${{ needs.deploy-production.outputs.previous-version }}"

      - name: Send alerts
        run: |
          echo "Sending critical alerts..."

  # ============================================
  # PHASE 6: MANUAL ROLLBACK (when triggered)
  # ============================================

  manual-rollback:
    name: Manual Rollback
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.is-rollback == 'true'

    environment:
      name: ${{ needs.prepare.outputs.target-env }}

    steps:
      - name: Perform rollback
        run: |
          echo "=== MANUAL ROLLBACK ==="
          echo "Environment: ${{ needs.prepare.outputs.target-env }}"
          echo "Version: ${{ needs.prepare.outputs.rollback-version }}"
          echo "Rolling back..."

      - name: Verify rollback
        run: echo "Rollback verified successfully!"

  # ============================================
  # PHASE 7: NOTIFICATION & SUMMARY
  # ============================================

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [prepare, test, build-and-push, deploy-staging, smoke-tests-staging, deploy-production, health-check-production, manual-rollback]
    if: always()

    steps:
      - name: Determine status
        id: status
        run: |
          if [ "${{ needs.prepare.outputs.is-rollback }}" == "true" ]; then
            if [ "${{ needs.manual-rollback.result }}" == "success" ]; then
              echo "status=rollback_success" >> $GITHUB_OUTPUT
            else
              echo "status=rollback_failed" >> $GITHUB_OUTPUT
            fi
          elif [ "${{ needs.health-check-production.result }}" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "${{ needs.smoke-tests-staging.result }}" == "success" ]; then
            echo "status=staging_only" >> $GITHUB_OUTPUT
          elif [ "${{ needs.test.result }}" == "success" ]; then
            echo "status=tests_only" >> $GITHUB_OUTPUT
          else
            echo "status=failed" >> $GITHUB_OUTPUT
          fi

      - name: Send notification
        run: |
          echo "=== DEPLOYMENT NOTIFICATION ==="
          echo "Status: ${{ steps.status.outputs.status }}"
          echo "Commit: ${{ github.sha }}"
          echo "Actor: ${{ github.actor }}"
          # Add Slack/Teams/Email notification here

      - name: Generate summary
        run: |
          echo "## CD Pipeline Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Stage | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Tests | ${{ needs.test.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ needs.build-and-push.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Deploy | ${{ needs.deploy-staging.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Staging Tests | ${{ needs.smoke-tests-staging.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production Deploy | ${{ needs.deploy-production.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Production Health | ${{ needs.health-check-production.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
